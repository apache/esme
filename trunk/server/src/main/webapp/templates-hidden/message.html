<html xmlns="http://www.w3.org/1999/xhtml" xmlns:lift="http://liftweb.net/"
      xml:lang="eng">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <title>Enterprise Social Messaging Experiment: Messages</title>

    <lift:Style.header />

    <script id="jquery" src="/classpath/jquery.js" type="text/javascript"/>
    <script id="json" src="/classpath/json.js" type="text/javascript"/>

  </head>
  <body>
    <div class="container">
      <div class="head">
        <img src="/images/esme-blue.png" alt="ESME" />
        <ul class="b-primary">
          <li><lift:Menu.item name="EditUser"/></li>
          <li><lift:Menu.item name="about"/></li>
          <li><lift:Menu.item name="list_users"/></li>
          <li><lift:Menu.item name="trackMgt"/></li>
          <li><lift:Menu.item name="actionMgt"/></li>
          <li><lift:Menu.item name="authToken"/></li>
          <li><lift:Menu.item name="Logout"/></li>
        </ul>
      </div>

      <table class="l-page l-page-massage">
        <tbody>
          <tr>
            <td class="l-page-r">
              <div class="l-top">
                <div id="tabs" >
                  <dl class="messages">
                    <dt class="caption">Your timeline</dt>

                    <dd>
                      <lift:comet type="Timeline"/>
                      <div class="b-list">
                      <table id="timeline_messages">
                        <thead>
                          <tr>
                              <th>Author</th>
                              <th>Message</th>
                              <th>Tags</th>
                              <th>Source</th>
                              <th>Date</th>
                          </tr>
                        </thead>
<!-- msgArray is an array of objects of the form:
  'conversation': 0, 'author': 1, 'replyto': 0, 'viagroup': 0, 'id': 1,
  'text': '<message><body>Checking out the latest ESME</body>\u000a
        <tags><tag name="Esme" id="1"></tag></tags></message>',
  'source': 'web', 'when': 1230587914019}
-->
                        <script>
                    // <![CDATA[
                            function msgDateCompare(msg1, msg2)
                            {
                                return parseInt(msg1.when) - parseInt(msg2.when);
                            }

                            function displayMessages(msgArray, spanId)
                            {
                                // Select the first element in table id="timeline_messages"
                                //  with id="message" as the message template
                                if (msgTemplate == null) {
//                                    var msgTemplate = jQuery('span.'+spanId+' message:first');
                                    var msgTemplate = jQuery('table#timeline_messages #message:first');
                                    var tagTemplate = msgTemplate.find('#tag:first');
                                    var msgInsertPt = jQuery('table#timeline_messages #messages');

                                    // Now we have the template, make the existing instances invisible
                                    jQuery('table#timeline_messages *[id=message]').hide();
                                }

                                // Sort the messages into date order
                                msgArray.sort(msgDateCompare);

                                for (var msgIndex in msgArray)
                                {
                                    // Marshall the data from the Comet-supplied message
                                    var cometMsg = msgArray[msgIndex];
                                    var msgId = "message_"+cometMsg.id;

                                    // Only do this if the message is not already in the table
                                    if (jQuery('table#timeline_messages #'+msgId).size() == 0)
                                    {
                                        var msgAuthor = cometMsg.author;
                                        var msgBody = jQuery(cometMsg.text).find('body').html();
                                        var msgDateObj = new Date(parseInt(cometMsg.when));
                                        var msgDateStr = msgDateObj.toLocaleDateString() +
                                            ' ' + msgDateObj.toLocaleTimeString();
                                        var msgSource = cometMsg.source;
                                        var msgTags = jQuery(cometMsg.text).find('tag').get();
                                        for (var tagIndex=0; tagIndex < msgTags.length; tagIndex++) {
                                            // Replace each tag element with the plain tag text
                                            msgTags[tagIndex] = jQuery(msgTags[tagIndex]).attr('name');
                                        }

                                        // Put the marshalled data into a copy of the template
                                        var newMsg = msgTemplate.clone(true).attr('id',msgId);

                                        newMsg.find('#author').text(msgAuthor);
                                        newMsg.find('#body').html(msgBody);
                                        newMsg.find('#source').text(msgSource);
                                        newMsg.find('#when').text(msgDateStr);
                                        for (var tagIndex=0; tagIndex < msgTags.length; tagIndex++) {
//                                            alert('msgId: '+msgId+' msgTags['+tagIndex+'] = '+ msgTag);

                                            var newTag = tagTemplate.clone(true).attr('id',msgTags[tagIndex]);
                                            newTag.find('a')
                                                .attr('href','tag/'+msgTags[tagIndex])
                                                .text(msgTags[tagIndex]);
                                            newTag.insertBefore(newMsg.find('#tag'));
                                        }
                                        // Remove any old tags from the template
                                        newMsg.find('*[id=tag]').remove();

                                        // Insert the updated copy of the message into the page
                                        newMsg.prependTo(msgInsertPt).show();
                                    }
                                }
                            }
                    // ]]>
                        </script>
                        <tbody id="messages">
                          <tr id="message">
                              <td id="author">dhague</td>
                              <td class="message">
                                <div class="outer"><div class="inner clear">
                                    <p class="text" id="body">This is a test message in the HTML for designers.</p>
                                </div></div>
                              </td>
                              <td id="tags" class="tag">
                                  <p id="tag"><a href="tag/tag1">tag1</a></p>
                                  <p id="tag"><a href="tag/tag2">tag2</a></p>
                              </td>
                              <td id="source">web</td>
                              <td id="when" class="date">Jan 1, 2009 12:00</td>
                          </tr>
                          <tr id="message">
                              <td id="author">user2</td>
                              <td class="message">
                                <div class="outer"><div class="inner clear">
                                    <p class="text" id="body">This is another test message in the HTML for designers.</p>
                                </div></div>
                              </td>
                              <td id="tags" class="tag">
                                  <p id="tag"><a href="tag/tag1">tag1</a></p>
                                  <p id="tag"><a href="tag/tag3">tag3</a></p>
                              </td>
                              <td id="source">web</td>
                              <td id="when" class="date">Jan 1, 2009 11:58</td>
                          </tr>
                        </tbody>
                      </table>
                      </div>
                    </dd>
                  </dl>

                  <dl class="tagclouds">
                    <dt class="caption">
                      Public Timeline
                    </dt>

                    <dd class="b-clouds">
                      <lift:comet type="PublicTimeline" />
                    </dd>
                  </dl>
                  <dl class="contacts">
                    <dt class="caption">
                      Contacts
                    </dt>

                    <dd class="b-contacts" style="height: 240px; overflow: auto">
                      Following:
                      <lift:UserSnip.following/>
                    </dd>
                    <dd class="b-contacts" style="height: 240px; overflow: auto">
                      Followers:
                      <lift:UserSnip.followers/>
                    </dd>
                  </dl>
                </div>
              </div>
            </td>
            <td class="l-page-l">
              <div class="b-edit">
                <h2 class="title">Welcome<span class="name"><lift:UserSnip.name /></span></h2>

                <div class="b-popup-c">
                  <div class="row clear">
                    <label>What are you working on?</label>
                    <textarea rows="4" cols="20" id="textdude"
                              style="width: 90%"></textarea
                    >
                  </div>
                  <div class="row clear"
                       style="display: none;"
                       id="reply-to-div">
                    Replying to <span id="reply-to-span">&nbsp;</span>
                    <button onclick="clearReplyTo()">remove reply</button>
                  </div>

                  <div class="row clear">
                    <label>Tag your message</label>
                    <input id="tagdude" style="width: 90%"/>
                    <div class="note clear">
                      <span class="l">use commas to
                      separate tags</span>
                      <span class="r">not required</span>
                    </div>
                  </div>

                  <div class="row clear"><a class="btn" href="javascript:post_msg();"><img src="/images/send-message.png" alt="Send Message" /></a></div>

                  <script>
                    // <![CDATA[
                    var currentConvNumber = 0;

                    function setReplyTo(id, text) {
                      currentConvNumber = id;
                      document.getElementById('reply-to-div').style.display = "block";
                      jQuery('#reply-to-span').text(text);
                    }

                    function clearReplyTo() {
                      currentConvNumber = 0;
                      document.getElementById('reply-to-div').style.display = "none";
                    }
                    // ]]>
                  </script>
                  <lift:UserSnip.postScript />
                </div>


                <div class="b-cloud">
                  <lift:comet type="TagCloud"/>
                </div>

                <div class="bugs">
                  <form action="/user_view/search"
                        class="b-primay"><input style="height: 20px; background: #c9d8ea;"
                                            name="term"/>
                    <input style="height: 22px; background: #233e5e; color: #c9d8ea;" type="submit" value="Search"/>
                  </form>
                </div>
              </div>
            </td>


          </tr>
        </tbody>
      </table>
    </div>
    <div class="foot">
      <center>ESME</center>
    </div>
  </body>
</html>
