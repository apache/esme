<html xmlns="http://www.w3.org/1999/xhtml" xmlns:lift="http://liftweb.net/"
      xml:lang="eng">
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/>
    <title>Enterprise Social Messaging Experiment: Messages</title>

    <lift:Style.header />

    <script id="jquery" src="/classpath/jquery.js" type="text/javascript"/>
    <script id="json" src="/classpath/json.js" type="text/javascript"/>
    <script>
      // <![CDATA[
      /*
       * displayMessages called by lift:comet, type="Timeline" and type="PublicTimeline"
       */

      function msgDateCompare(msg1, msg2)
      {
        return parseInt(msg1.message.when) - parseInt(msg2.message.when);
      }

      function displayMessages(msgArray, elementId)
      {
        // Select the first element in table id="timeline_messages"
        //  with id="message" as the message template
        if (msgTemplate == null) {
          //                                    var msgTemplate = jQuery('span.'+spanId+' message:first');
          var msgTemplate = jQuery('#'+elementId+' #message:first');
          var tagTemplate = msgTemplate.find('#tag:first');
          var msgInsertPt = jQuery('#'+elementId);

          // Now we have the template, make the existing instances invisible
          jQuery('#'+elementId+' *[id=message]').hide();
        }

        // Sort the messages into date order
        msgArray.sort(msgDateCompare);

        for (var msgIndex in msgArray)
        {
          // Marshall the data from the Comet-supplied message
          var cometMsg = msgArray[msgIndex].message;
          var cometReason = msgArray[msgIndex].reason;
          var cometResent = msgArray[msgIndex].resent;
          var msgId = "message_"+cometMsg.id;

          // Only do this if the message is not already in the table
          if (jQuery('#'+elementId+' #'+msgId).size() == 0)
          {
            var msgAuthor = cometMsg.author;
            var msgBody = jQuery(cometMsg.text).find('body').html();
            var msgDateObj = new Date(parseInt(cometMsg.when));
            var msgDateStr = 'on ' + msgDateObj.toLocaleDateString() +
              ' ' + msgDateObj.toLocaleTimeString();
            var msgPool = '';
            if (cometMsg.pool) msgPool = 'in pool ' + cometMsg.pool.name;
            var msgSource = cometMsg.source;
            var msgReason = ""
            for (r in cometReason) {
              if (r == "resent_from")
                msgReason = "resent by " + cometReason[r].nickname;
              else
                msgReason = "caused by " + r;
              break
            }
            var msgTags = jQuery(cometMsg.text).find('tags > tag').get();
            for (var tagIndex=0; tagIndex < msgTags.length; tagIndex++) {
              // Replace each tag element with the plain tag text
              msgTags[tagIndex] = jQuery(msgTags[tagIndex]).attr('name');
            }

            // Put the marshalled data into a copy of the template
            var newMsg = msgTemplate.clone(true).attr('id',msgId);

            newMsg.find('#author').text(msgAuthor.nickname);

            var avatar = newMsg.find('#avatar')
            .attr('src', msgAuthor.imageurl)
            .attr('alt',msgAuthor.firstname + ' ' + msgAuthor.lastname);

            newMsg.find('#body').html(msgBody);
            newMsg.find('#pool').text(msgPool);
            newMsg.find('#source').text(msgSource);
            newMsg.find('#reason').text(msgReason);
            newMsg.find('#when').text(msgDateStr);
            var id = cometMsg.id;
            var resendButton = newMsg.find('#resend');
            if (cometResent) {
              resendButton.css("display", "none");
            } else {
              resendButton.attr('id', 'resend_' + id).
                attr('onclick', 'javascript:resend_msg(' + id + ');' +
                                           'clearResend("resend_' + id + '")');
            }
            for (var tagIndex=0; tagIndex < msgTags.length; tagIndex++) {
              var newTag = tagTemplate.clone(true).attr('id',msgTags[tagIndex]);
              newTag.find('a')
              .attr('href','tag/'+msgTags[tagIndex])
              .text(msgTags[tagIndex]);
              newTag.insertBefore(newMsg.find('#tag:first'));
            }

            // Remove any old tags from the template
            newMsg.find('*[id=tag]').remove();

            // Insert the updated copy of the message into the page
            newMsg.prependTo(msgInsertPt).show();
          }
        }
      }
      // ]]>
    </script>

  </head>
  <body>
    <div class="container">
      <div class="head">
        <img src="/images/esme.png" alt="ESME" />
        <img src="/images/ajax-loader.gif" style="display: none" id="ajax-loader"/>
        <ul class="b-primary">
          <li><lift:Menu.item name="sign_up"/></li>
          <li><lift:Menu.item name="EditUser"/></li>
          <li><lift:Menu.item name="about"/></li>
          <li><lift:Menu.item name="list_users"/></li>
          <li><lift:Menu.item name="trackMgt"/></li>
          <li><lift:Menu.item name="actionMgt"/></li>
          <li><lift:Menu.item name="authToken"/></li>
          <li><lift:Menu.item name="accessPools"/></li>
          <li><lift:Menu.item name="streams"/></li>
          <li><lift:Menu.item name="logout"/></li>
        </ul>
      </div>

      <table class="l-page l-page-massage">
        <tbody>
          <tr>
            <td class="l-page-r">
              <div class="l-top">
                <div id="tabs" >
                  <dl class="messages">
                    <dt class="caption">Your timeline</dt>

                    <dd>
                      <div class="b-list">
                        <table>
                          <thead>
                            <tr>
                              <th>Author</th>
                              <th>Message</th>
                              <th>Tags</th>
                            </tr>
                          </thead>
                          <lift:comet type="Timeline"/>
                          <tbody id="timeline_messages">
                            <tr id="message">
                              <td><img id="avatar" src="http://static.twitter.com/images/default_profile_bigger.png" alt="Anonymous" width="50px"/><div id="author">anon</div></td>
                              <td class="message">
                                <div class="outer">
                                  <div class="inner clear">
                                    <p class="text" id="body">This is a test message in the HTML for designers.</p>
                                  </div>
                                  <div class="metainfo">
                                    <span id="pool">in pool PUBLIC</span>
                                    <span id="reason">resent by me</span>
                                    <span id="when" class="date">today</span>
                                  </div>
                                </div>
                              </td>
                              <td id="tags" class="tag">
                                <p id="tag"><a href="tag/tag1">tag1</a></p>
                                <p id="tag"><a href="tag/tag2">tag2</a></p>
                              </td>
                              <td><button id="resend" class="btn">Resend</button></td>
                            </tr>
                            <tr id="message">
                              <td><img id="avatar" src="http://static.twitter.com/images/default_profile_bigger.png" alt="Anonymous" width="50px"/><div id="author">anon</div></td>
                              <td class="message">
                                <div class="outer">
                                  <div class="inner clear">
                                      <p class="text" id="body">This is another test message in the HTML for designers.</p>
                                  </div>
                                  <div class="metainfo">
                                    <span id="pool">in pool PUBLIC</span>
                                    <span id="reason">resent by me</span>
                                    <span id="when" class="date">yesterday</span>
                                  </div>
                                </div>
                              </td>
                              <td id="tags" class="tag">
                                <p id="tag"><a href="tag/tag1">tag1</a></p>
                                <p id="tag"><a href="tag/tag3">tag3</a></p>
                              </td>
                              <td><button id="resend" class="btn">Resend</button></td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </dd>
                  </dl>
                  <lift:UserSnip.resendScript/>

                  <dl class="tagclouds">
                    <dt class="caption">Public timeline</dt>

                    <dd>
                      <div class="b-list">
                        <table>
                          <thead>
                            <tr>
                              <th>Author</th>
                              <th>Message</th>
                              <th>Tags</th>
                            </tr>
                          </thead>
                          <lift:comet type="PublicTimeline"/>
                          <tbody id="public_timeline_messages">
                            <tr id="message">
                              <td id="author">dhague</td>
                              <td class="message">
                                <div class="outer">
                                  <div class="inner clear">
                                    <p class="text" id="body">This is a public timeline message in the HTML for designers.</p>
                                  </div>
                                  <div class="metainfo">
                                    <span id="when" class="date">now</span>
                                  </div>
                                </div>
                              </td>
                              <td id="tags" class="tag">
                                <p id="tag"><a href="tag/tagA">tagA</a></p>
                                <p id="tag"><a href="tag/tagB">tagB</a></p>
                              </td>
                            </tr>
                          </tbody>
                        </table>
                      </div>
                    </dd>
                  </dl>
                  <dl class="contacts">
                    <dt class="caption">
                      Contacts
                    </dt>

                    <dd class="b-contacts" style="height: 240px; overflow: auto">
                      Following:
                      <lift:UserSnip.following/>
                    </dd>
                    <dd class="b-contacts" style="height: 240px; overflow: auto">
                      Followers:
                      <lift:UserSnip.followers/>
                    </dd>
                  </dl>
                </div>
              </div>
            </td>
            <td class="l-page-l">
              <div class="b-edit">
                <h2 class="title">Welcome<span class="name"><lift:UserSnip.name /></span></h2>

                <div class="b-popup-c">
                  <div class="row clear">
                    <label>What are you working on?</label>
                    <textarea rows="4" cols="20" id="textdude"
                              style="width: 90%"></textarea
                    >
                  </div>
                  <div class="row clear"
                       style="display: none;"
                       id="reply-to-div">
                    Replying to <span id="reply-to-span">&nbsp;</span>
                    <button onclick="clearReplyTo()">remove reply</button>
                  </div>

                  <div class="row clear" style="display: none">
                    <label>Tag your message</label>
                    <input id="tagdude" style="width: 90%"/>
                    <div class="note clear">
                      <span class="l">use commas to
                      separate tags</span>
                      <span class="r">not required</span>
                    </div>
                  </div>

                  <div class="row clear">
                    <label>Access pool</label>
                    <select id="access_pool">
                      <option id="0">--public--</option>
                      <lift:UserSnip.accessPools />
                    </select>
                  </div>

                  <div class="row clear"><button class="btn" onclick="javascript:post_msg();">Update<!--<img src="/images/send-message.png" alt="Send Message" />--></button></div>

                  <script>
                    // <![CDATA[
                    var currentConvNumber = 0;

                    function setReplyTo(id, text) {
                      currentConvNumber = id;
                      document.getElementById('reply-to-div').style.display = "block";
                      jQuery('#reply-to-span').text(text);
                    }

                    function clearReplyTo() {
                      currentConvNumber = 0;
                      document.getElementById('reply-to-div').style.display = "none";
                    }
                    
                    function clearResend(id) {
                      document.getElementById(id).style.display="none"
                    }
                    // ]]>
                  </script>
                  <lift:UserSnip.postScript />
                </div>


                <div class="b-cloud">
                  <lift:comet type="TagCloud"/>
                </div>
                
                <div class="b-stats">
                  <p id="stats-para">Popular messages</p>
                  <lift:UserSnip.popular/>
                </div>

                <div class="b-stats">
                  <p id="stats-para">Popular links</p>
                  <lift:UserSnip.links/>
                </div>

                <lift:ignore>
                  <div class="bugs">
                    <form action="/user_view/search"
                          class="b-primay"><input style="height: 20px; background: #c9d8ea;"
                                              name="term"/>
                      <input style="height: 22px; background: #233e5e; color: #c9d8ea;" type="submit" value="Search"/>
                    </form>
                  </div>
                </lift:ignore>

              </div>
            </td>


          </tr>
        </tbody>
      </table>
    </div>
    <div class="foot">
      <center>ESME</center>
    </div>
  </body>
</html>
